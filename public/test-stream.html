<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stream API Test - ModelTriage</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 {
      margin: 0 0 24px 0;
      font-size: 24px;
    }
    textarea {
      width: 100%;
      min-height: 100px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
    }
    button {
      background: #0070f3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
      margin-top: 12px;
    }
    button:hover {
      background: #0051cc;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .response {
      margin-top: 24px;
      padding: 16px;
      background: #f9f9f9;
      border-radius: 4px;
      border: 1px solid #e0e0e0;
      min-height: 100px;
      white-space: pre-wrap;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    .metadata {
      margin-top: 12px;
      padding: 12px;
      background: #e8f4ff;
      border-radius: 4px;
      font-size: 13px;
    }
    .error {
      background: #fee;
      border-color: #fcc;
      color: #c00;
    }
    .status {
      margin-top: 12px;
      font-size: 13px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Stream API Test</h1>
    
    <form id="streamForm">
      <label for="prompt">
        <strong>Prompt:</strong>
      </label>
      <textarea 
        id="prompt" 
        name="prompt" 
        placeholder="Enter your prompt here..."
        required
      >Hello, how are you?</textarea>
      
      <button type="submit" id="submitBtn">Stream Response</button>
      <div class="status" id="status"></div>
    </form>

    <div id="responseContainer" style="display: none;">
      <h3>Response:</h3>
      <div class="response" id="response"></div>
      <div class="metadata" id="metadata"></div>
    </div>
  </div>

  <script>
    const form = document.getElementById('streamForm');
    const promptInput = document.getElementById('prompt');
    const submitBtn = document.getElementById('submitBtn');
    const responseContainer = document.getElementById('responseContainer');
    const responseDiv = document.getElementById('response');
    const metadataDiv = document.getElementById('metadata');
    const statusDiv = document.getElementById('status');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const prompt = promptInput.value.trim();
      if (!prompt) return;

      // Reset UI
      submitBtn.disabled = true;
      responseDiv.textContent = '';
      responseDiv.className = 'response';
      metadataDiv.textContent = '';
      responseContainer.style.display = 'block';
      statusDiv.textContent = 'üîÑ Streaming...';

      try {
        const response = await fetch('/api/stream', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ prompt }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Request failed');
        }

        if (!response.body) {
          throw new Error('No response body');
        }

        // Read SSE stream
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop() || '';

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              const data = JSON.parse(line.slice(6));

              if (data.type === 'chunk') {
                responseDiv.textContent += data.content;
              } else if (data.type === 'metadata') {
                const meta = data.metadata;
                metadataDiv.innerHTML = `
                  <strong>Metadata:</strong><br>
                  Model: ${meta.model}<br>
                  Provider: ${meta.provider}<br>
                  Latency: ${meta.latency}ms<br>
                  Tokens: ${meta.tokenUsage?.total || 'N/A'}
                `;
                statusDiv.textContent = '‚úÖ Stream complete';
              } else if (data.type === 'error') {
                throw new Error(data.error);
              }
            }
          }
        }
      } catch (error) {
        responseDiv.textContent = `Error: ${error.message}`;
        responseDiv.className = 'response error';
        statusDiv.textContent = '‚ùå Error occurred';
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
